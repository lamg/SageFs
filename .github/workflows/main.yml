name: main build

on:
  pull_request:
  push:
    branches:
    - master

jobs:
  build:
    strategy:
      matrix:
        platform: [ubuntu-latest, windows-latest]

    runs-on: ${{ matrix.platform }}

    steps:
    - uses: actions/checkout@v5

    - name: Checkout forked MCP SDK
      uses: actions/checkout@v5
      with:
        repository: WillEhrendreich/ModelContextProtocolSdk
        path: mcp-sdk

    - name: Install Dotnet
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: |
          10.0.x

    - name: Build forked MCP SDK packages
      run: |
        dotnet pack mcp-sdk/src/ModelContextProtocol.Core -o mcp-sdk-nupkg -c Release
        dotnet pack mcp-sdk/src/ModelContextProtocol -o mcp-sdk-nupkg -c Release
        dotnet pack mcp-sdk/src/ModelContextProtocol.AspNetCore -o mcp-sdk-nupkg -c Release

    - name: Build
      run: dotnet build
      
    - name: Test
      shell: bash
      run: |
        set +e
        dotnet run --no-build --project SageFs.Tests -- --summary
        rc=$?
        # Expecto exit code 2 = no TTY (cosmetic); treat as success
        if [ $rc -eq 0 ] || [ $rc -eq 2 ]; then exit 0; else exit $rc; fi
      timeout-minutes: 10

  publish:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    permissions:
      contents: write
      packages: write

    steps:
    - uses: actions/checkout@v5

    - name: Checkout forked MCP SDK
      uses: actions/checkout@v5
      with:
        repository: WillEhrendreich/ModelContextProtocolSdk
        path: mcp-sdk

    - name: Install Dotnet
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: |
          10.0.x

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Build forked MCP SDK packages
      run: |
        dotnet pack mcp-sdk/src/ModelContextProtocol.Core -o mcp-sdk-nupkg -c Release
        dotnet pack mcp-sdk/src/ModelContextProtocol -o mcp-sdk-nupkg -c Release
        dotnet pack mcp-sdk/src/ModelContextProtocol.AspNetCore -o mcp-sdk-nupkg -c Release

    - name: Get version
      id: version
      run: |
        version=$(grep -oP '(?<=<Version>)[^<]+' Directory.Build.props)
        echo "version=$version" >> $GITHUB_OUTPUT

    - name: Pack SageFs
      run: dotnet pack SageFs -c Release -o release

    - name: Build VS Code extension
      working-directory: sagefs-vscode
      run: |
        dotnet tool restore
        npm ci
        npx @vscode/vsce package -o ../release/sagefs-vscode-${{ steps.version.outputs.version }}.vsix

    - name: Build Visual Studio extension
      id: vs-build
      continue-on-error: true
      run: |
        dotnet build sagefs-vs/SageFs.VisualStudio/SageFs.VisualStudio.csproj -c Release
        for f in sagefs-vs/SageFs.VisualStudio/bin/Release/*.vsix; do
          [ -f "$f" ] && cp "$f" "release/sagefs-visualstudio-${{ steps.version.outputs.version }}.vsix"
        done

    - name: Warn if VS extension build failed
      if: steps.vs-build.outcome == 'failure'
      run: echo "::warning::Visual Studio extension build failed â€” VSIX will not be included in this release"

    - name: Push to NuGet
      run: dotnet nuget push release/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ steps.version.outputs.version }}
        name: v${{ steps.version.outputs.version }}
        files: |
          release/*.nupkg
          release/*.vsix
        body: |
          ## SageFs v${{ steps.version.outputs.version }}

          ### Downloads
          - **NuGet**: `dotnet tool install --global SageFs`
          - **VS Code Extension** (`sagefs-vscode-*.vsix`): Install via `code --install-extension sagefs-vscode-${{ steps.version.outputs.version }}.vsix`
          - **Visual Studio Extension** (`sagefs-visualstudio-*.vsix`): Double-click to install in Visual Studio 2022+
          - **Neovim**: See [sagefs.nvim](https://github.com/WillEhrendreich/sagefs.nvim)
        make_latest: true

    - name: Sync sagefs.nvim version tag
      env:
        NVIM_PAT: ${{ secrets.SAGEFS_NVIM_PAT }}
      if: env.NVIM_PAT != ''
      continue-on-error: true
      run: |
        cd "$(mktemp -d)"
        git clone --depth 1 https://x-access-token:${NVIM_PAT}@github.com/WillEhrendreich/sagefs.nvim.git .
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        # Update version.lua to match
        echo "return '${{ steps.version.outputs.version }}'" > lua/sagefs/version.lua
        git add lua/sagefs/version.lua
        git diff --cached --quiet || git commit -m "chore: sync version to v${{ steps.version.outputs.version }}"
        git push origin main || true
        git tag -f "v${{ steps.version.outputs.version }}" -m "Release v${{ steps.version.outputs.version }} (synced from SageFs)"
        git push origin "v${{ steps.version.outputs.version }}" --force
