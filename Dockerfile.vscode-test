# SageFs integration test environment
# For headless VS Code testing with Playwright via CDP
#
# Stage 1: .NET SDK + SageFs daemon (for API tests)
# Stage 2: + VS Code + Xvfb (for full extension tests)

FROM mcr.microsoft.com/dotnet/sdk:10.0-noble AS sagefs-base

# SageFs nupkg will be copied in at build time
COPY nupkg/ /tmp/nupkg/

# Install SageFs as a global tool from local nupkg
RUN dotnet tool install --global SageFs --add-source /tmp/nupkg/ --no-cache && \
    rm -rf /tmp/nupkg/

ENV PATH="/root/.dotnet/tools:${PATH}"
ENV SAGEFS_BIND_HOST=0.0.0.0

# Working directory for test projects
WORKDIR /workspace

# Health check: SageFs daemon exposes /health
HEALTHCHECK --interval=2s --timeout=3s --retries=10 \
  CMD curl -sf http://localhost:37749/health || exit 1

# Default: start SageFs daemon (lowercase on Linux)
ENTRYPOINT ["/root/.dotnet/tools/sagefs"]

# -------------------------------------------------------------------
# VS Code extension test image (extends sagefs-base with display + VS Code)
# -------------------------------------------------------------------
FROM sagefs-base AS vscode-test

# Install Xvfb + VS Code dependencies
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
      xvfb dbus curl gpg apt-transport-https \
      libnss3 libatk1.0-0 libatk-bridge2.0-0 libcups2 \
      libdrm2 libxkbcommon0 libxcomposite1 libxdamage1 \
      libxrandr2 libgbm1 libpango-1.0-0 libcairo2 \
      libasound2t64 libxshmfence1 && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Install VS Code
RUN curl -fsSL https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > /usr/share/keyrings/packages.microsoft.gpg && \
    echo "deb [arch=amd64 signed-by=/usr/share/keyrings/packages.microsoft.gpg] https://packages.microsoft.com/repos/code stable main" \
      > /etc/apt/sources.list.d/vscode.list && \
    apt-get update && \
    apt-get install -y code && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Pre-configure VS Code (no trust dialogs, no telemetry, no updates)
RUN mkdir -p /root/.config/Code/User && \
    echo '{"security.workspace.trust.enabled":false,"workbench.startupEditor":"none","update.mode":"none","extensions.autoCheckUpdates":false,"telemetry.telemetryLevel":"off","window.restoreWindows":"none"}' \
      > /root/.config/Code/User/settings.json

# VS Code extension VSIX will be installed at runtime via bind mount
ENV DISPLAY=:99

# Entrypoint starts Xvfb then the provided command
COPY docker/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]

